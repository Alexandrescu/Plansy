@using System.Web.UI.WebControls
@using MaProgramez.Resources
@using MaProgramez.Website.Helpers
@using MvcPaging
@model IPagedList<MaProgramez.Repository.Entities.ApplicationUser>

    @{
    ViewBag.Title = Resource.UserAdminView_Title;
    Layout = MVC.Shared.Views._Layout;

    var sortBy = ViewBag.SortBy as string;
    var ascending = (bool)ViewBag.Ascending;
    var filterBy = ViewBag.FilterBy as string;
    var role = ViewBag.RoleName as string;
    var categoryId = ViewBag.CategoryId as int?;
    }

    <div class="clear"></div>

    <section class="filtre">

        <div class="container">
            <div class="col-lg-5 schedule">
                <h4>@Resource.UserAdminView_Title</h4>
            </div><!-- /.col-lg-3 -->
            @using (Html.BeginForm("Index", "UsersAdmin", FormMethod.Get))
            {
            <div class="col-lg-4">
                <div class="input-group">
                    <input type="text" name="filterBy" class="form-control cautare" style="border: none !important;" placeholder="@Resource.Search" value="@filterBy" />
                    <span class="input-group-btn">
                        <button class="btn btn-default btn-cautare" type="submit"><span class="glyphicon glyphicon-search"></span></button>
                    </span>
                </div><!-- /input-group -->
            </div><!-- /.col-lg-6 -->
            }
            <a href="@Url.Action(MVC.UsersAdmin.Create())" class="btn btn-primary buton5 float-right" style="margin-right: 20px; margin-top:1px;">@Resource.UserAdminView_Add</a>
        </div>
    </section>
    <div class="up-toticket">
        &nbsp;
    </div>
    <section class="sectiune-cat stilizat-cat">
        <div class="container stilizat">


            @using (Html.BeginForm("Index", "UsersAdmin", FormMethod.Get, new { @class = "form-horizontal", role = "form" }))
            {
            <div class="row">
                <label class="col-md-3 form-label">
                    @(Resource.SelectUserRole):
                </label>
                <div class="col-md-9">
                    <ul class="filter-links" style="margin-bottom: 0;">
                        @foreach (var item in (SelectList)ViewBag.RoleNames)
                        {
                        <li class="@(item.Value == ViewBag.RoleName ? "active" : string.Empty)">
                            <a href="@Url.Action(MVC.UsersAdmin.Index(null, item.Value, sortBy, filterBy, categoryId, ascending))">@item.Value</a>
                        </li>
                        }
                        <li class="@(role == null ? "active" : string.Empty)">
                            <a href="@Url.Action(MVC.UsersAdmin.Index(null, string.Empty, string.Empty, string.Empty, null))">@Resource.Reset</a>
                        </li>
                    </ul>
                </div>
            </div>

            if (ViewBag.RoleName == "Provider")
            {
            <div class="row">
                <label class="col-md-3 form-label">
                    @(Resource.Category):
                </label>
                <div class="col-md-9">
                    <ul class="filter-links" style="margin-bottom: 0;">
                        @foreach (var item in (SelectList)ViewBag.Categories)
                        {
                        <li class="@(item.Value.ToInteger() == ViewBag.CategoryId ? "active" : string.Empty)">
                            <a href="@Url.Action(MVC.UsersAdmin.Index(null, role, sortBy, filterBy, item.Value.ToInteger(), ascending))">@item.Text</a>
                        </li>
                        }
                        <li class="@(ViewBag.CategoryId == null ? "active" : string.Empty)">
                            <a href="@Url.Action(MVC.UsersAdmin.Index(null, role, string.Empty, string.Empty, null))">@Resource.Reset</a>
                        </li>
                    </ul>
                </div>
            </div>
            }
            }

            <div class="sablon">
                <table class="table table-striped table-bordered table-hover">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th><a href="@Url.Action(MVC.UsersAdmin.Index(null, role, "email", filterBy, categoryId, sortBy != "email" || !ascending))" data-toggle="tooltip" data-placement="top" title=@Resource.Sort><i class="fa @MaProgramez.Website.Helpers.TableHelper.GetTableHeaderIcon(sortBy, "email", ascending)"></i> @Resource.Email</a></th>
                            <th><a href="@Url.Action(MVC.UsersAdmin.Index(null, role, "name", filterBy, categoryId, sortBy != "name" || !ascending))" data-toggle="tooltip" data-placement="top" title=@Resource.Sort><i class="fa @MaProgramez.Website.Helpers.TableHelper.GetTableHeaderIcon(sortBy, "name", ascending)"></i> @Html.DisplayNameFor(model => model.First().FirstName) @Html.DisplayNameFor(model => model.First().LastName)</a></th>
                            <th><a href="@Url.Action(MVC.UsersAdmin.Index(null, role, "company", filterBy, categoryId, sortBy != "company" || !ascending))" data-toggle="tooltip" data-placement="top" title=@Resource.Sort><i class="fa @MaProgramez.Website.Helpers.TableHelper.GetTableHeaderIcon(sortBy, "company", ascending)"></i> @Html.DisplayNameFor(model => model.First().CompanyName)</a></th>
                            <th><a href="@Url.Action(MVC.UsersAdmin.Index(null, role, "active", filterBy, categoryId, sortBy != "active" || !ascending))" data-toggle="tooltip" data-placement="top" title=@Resource.Sort><i class="fa @MaProgramez.Website.Helpers.TableHelper.GetTableHeaderIcon(sortBy, "active", ascending)"></i> @Resource.ActivatedAccount</a></th>
                            <th><a href="@Url.Action(MVC.UsersAdmin.Index(null, role, "date", filterBy, categoryId, sortBy != "date" || !ascending))" data-toggle="tooltip" data-placement="top" title=@Resource.Sort><i class="fa @MaProgramez.Website.Helpers.TableHelper.GetTableHeaderIcon(sortBy, "date", ascending)"></i> @Resource.CreatedDate</a></th>
                            <th><a href="@Url.Action(MVC.UsersAdmin.Index(null, role, "agent", filterBy, categoryId, sortBy != "agent" || !ascending))" data-toggle="tooltip" data-placement="top" title=@Resource.Sort><i class="fa @MaProgramez.Website.Helpers.TableHelper.GetTableHeaderIcon(sortBy, "agent", ascending)"></i> @Resource.Agent</a></th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                        var number = (ViewBag.Page * Model.PageSize) + 1;
                        }
                        @foreach (var item in Model)
                        {
                        var companyName = item.CompanyName + (!string.IsNullOrWhiteSpace(item.Alias) ? "(" + item.Alias + ")" : "");

                        <tr>
                            <td class="clickable-row" data-href="@Url.Action(MVC.UsersAdmin.Edit(item.Id))">@(number++)</td>
                            <td class="clickable-row" data-href="@Url.Action(MVC.UsersAdmin.Edit(item.Id))">@item.UserName</td>
                            <td class="clickable-row" data-href="@Url.Action(MVC.UsersAdmin.Edit(item.Id))">@item.FirstName @item.LastName</td>
                            <td class="clickable-row" data-href="@Url.Action(MVC.UsersAdmin.Edit(item.Id))">@companyName</td>
                            <td class="clickable-row" data-href="@Url.Action(MVC.UsersAdmin.Edit(item.Id))" style="text-align: center;">
                                @if (item.EmailConfirmed)
                                {
                                <i class="glyphicon glyphicon-ok" style="color: #98f600"></i>
                                }
                                else
                                {
                                <i class="fa fa-remove" style="color: #ea0073"></i>
                                }
                            </td>
                            <td class="clickable-row" data-href="@Url.Action(MVC.UsersAdmin.Edit(item.Id))">@item.CreatedDate.ToString("dd.MM.yyyy HH:mm")</td>
                            <td class="clickable-row" data-href="@Url.Action(MVC.UsersAdmin.Edit(item.Id))">
                                <p style="margin-bottom: 0;">
                                    @(item.AgentId != null ? string.Format("{0} {1}", item.Agent.FirstName, item.Agent.LastName) : "-")
                                </p>
                            </td>
                            <td class="dropdown">
                                <a class="dropdown-toggle" style="text-align: center; display: block; width: 100%; font-size: 18px;" data-toggle="dropdown" aria-expanded="true">
                                    <i class="fa fa-caret-down" style="color: #CCC"></i>
                                </a>
                                <ul class="dropdown-menu pull-right" role="menu" aria-labelledby="LanguageDropdownMenu">
                                    @if (!item.EmailConfirmed)
                                    {
                                    <li><a href="@Url.Action(MVC.UsersAdmin.ResendActivationEmail(item.Id))"><i class="fa fa-paper-plane"></i> @Resource.ResendActivationEmail</a></li>
                                    if (User.IsInRole("Admin") || User.IsInRole("Agent"))
                                    {
                                    <li><a href="@Url.Action(MVC.UsersAdmin.ActivateAccount(item.Id))"><i class="glyphicon glyphicon-phone"></i> @Resource.ActivateAccount_Title</a></li>
                                    }
                                    }

                                    <li><a href="@Url.Action(MVC.UsersAdmin.Edit(item.Id))"><i class="fa fa-edit"></i> @Resource.Edit</a></li>
                                    <li><a href="@Url.Action(MVC.UsersAdmin.SendNotification(item.Id))"><i class="fa fa-flag"></i> @Resource.SendNotification</a></li>

                                    @if (item.LockoutEndDateUtc != null)
                                    {
                                    <li><a href="@Url.Action(MVC.UsersAdmin.UnblockAccount(item.Id))"><i class="glyphicon glyphicon-ban-circle"></i> @Resource.UnblockAccount</a></li>
                                    }

                                    <li><a href="@Url.Action(MVC.Schedule.SchedulesList(item.Id, null))"><i class="glyphicon glyphicon-calendar"></i> @Resource.SchedulesList</a></li>

                                    @if (UserRoleHelper.UserHasRole(item.Id, "Provider"))
                                    {
                                    <li><a href="@Url.Action(MVC.UsersAdmin.SlotsList(item.Id))"><i class="fa fa-tags"></i> @Resource.SlotsList</a></li>
                                    if (User.IsInRole("Admin") || User.IsInRole("Agent"))
                                    {
                                    <li><a href="@Url.Action(MVC.Invoice.AdminInvoiceList(item.Id, 1, null, null, true))"><i class="fa fa-file-text-o"></i> @Resource.Invoices</a></li>
                                    }

                                    }

                                    @if (User.IsInRole("Admin"))
                                    {
                                    <li class="divider"></li>
                                    <li><a href="@Url.Action(MVC.UsersAdmin.Delete(item.Id))"><i class="fa fa-trash"></i> @Resource.Delete</a></li>
                                    }
                                </ul>
                            </td>
                        </tr>
                        }
                    </tbody>
                </table>
            </div>

            @if ((Model.TotalItemCount) > Model.PageSize)
            {
            @Html.Pager(Model.PageSize, Model.PageNumber, Model.TotalItemCount).Options(o => o
            .DisplayTemplate("Bootstrap3Pagination")
            .MaxNrOfPages(14)
            .AlwaysAddFirstPageNumber()
            .AddRouteValue("sortBy", sortBy)
            .AddRouteValue("ascending", ascending)
            .AddRouteValue("filterBy", filterBy)
            .AddRouteValue("role", role)
            )
            }

        </div>
    </section>
